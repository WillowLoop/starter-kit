name: Deploy Backend

on:
  # STAP 1: Uncomment na configuratie van COOLIFY_WEBHOOK_TOKEN en COOLIFY_WEBHOOK_URL.
  # Zie docs/workflows/cicd-setup.md voor instructies.
  #
  # push:
  #   branches: [main]
  #   paths: ['backend/**', '.github/workflows/deploy-backend.yml']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: staging
        type: choice
        options: [staging, production]

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: docker/setup-buildx-action@ba0d2a40e0da77f7a653d4b7cfc5bd080b5e7e38 # v4.2.0
      - uses: docker/login-action@9780b0c1be7ffe46b3260f08e91c5ae6404f82d8 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - id: meta
        uses: docker/metadata-action@dbf88876c6e7e392b0e1bbf6c2dcd9dae9ece8e2 # v5.8.0
        with:
          images: ghcr.io/${{ github.repository }}/backend
          tags: |
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}
      - uses: docker/build-push-action@1a1e1c01c94f49ffba8b13df7f64f4e72ab8db35 # v5.2.0
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/backend:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository }}/backend:buildcache,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
    steps:
      - name: Trigger Coolify deployment
        run: |
          curl --fail-with-body \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_WEBHOOK_TOKEN }}" \
            "${{ secrets.COOLIFY_WEBHOOK_URL }}"
      - name: Record deployment
        run: |
          echo "DEPLOY: sha=${{ github.sha }} env=${{ github.event.inputs.environment || 'staging' }} actor=${{ github.actor }} ts=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
