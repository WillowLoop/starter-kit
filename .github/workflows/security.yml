name: Security

on:
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * 1'  # Monday 06:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  bandit:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
      - run: uv sync --frozen --dev
      - run: uv run bandit -r . -c pyproject.toml -f sarif -o bandit.sarif
      - uses: github/codeql-action/upload-sarif@83b649a7f90e6c29fa03baf0d9b1b7a07e2a1d89 # v3.27.3
        with:
          sarif_file: backend/bandit.sarif

  pip-audit:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
      - run: uv sync --frozen --dev
      - run: uv run pip-audit --requirement <(uv export --no-dev --format requirements-txt)

  npm-audit:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml
      - run: pnpm install --frozen-lockfile
      - run: pnpm audit --audit-level=high --prod

  codeql:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        language: [javascript-typescript, python]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: github/codeql-action/init@83b649a7f90e6c29fa03baf0d9b1b7a07e2a1d89 # v3.27.3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended
      - uses: github/codeql-action/autobuild@83b649a7f90e6c29fa03baf0d9b1b7a07e2a1d89 # v3.27.3
      - uses: github/codeql-action/analyze@83b649a7f90e6c29fa03baf0d9b1b7a07e2a1d89 # v3.27.3

  # Trivy skipped on PRs â€” Docker build is expensive. Runs on push + weekly schedule.
  trivy:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Build image
        run: docker build -t scan-target:local ./backend
      - uses: aquasecurity/trivy-action@6e7b7d1fd3e4692cc592cda54c9c5d56c7563f88 # v0.24.0
        with:
          image-ref: scan-target:local
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
          ignore-unfixed: true
      - uses: github/codeql-action/upload-sarif@83b649a7f90e6c29fa03baf0d9b1b7a07e2a1d89 # v3.27.3
        with:
          sarif_file: trivy-results.sarif
